---
title: "Fetch GSOD Country List and Merge with ISO Country Codes"
author: "Adam H. Sparks"
date: "`r Sys.Date()`"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
# Introduction

This document details how to fetch the country list provided by the NCEI for
the GSOD stations from the FTP server and merge it with ISO codes from the
[_countrycode_](https://cran.r-project.org/package=countrycode)
package for inclusion in the _GSODR_ package in `/data/country-list.rda`. These
codes are used when a user selects a single country for a data query.

# R Data Processing

Read "country-list.txt" file from NCEI FTP server and merge with _countrycode_
data.

```{r download-merge-inspect, echo=TRUE, messages=FALSE}
if (!require("countrycode"))
{
  install.packages("countrycode",
                   repos = c(CRAN = "https://cran.rstudio.com"))
}

if (!require("data.table"))
{
  install.packages("data.table",
                   repos = c(CRAN = "https://cran.rstudio.com"))
}
```

```{r read-table, echo=TRUE, messages=FALSE}
countries <-
  readLines("https://www1.ncdc.noaa.gov/pub/data/igra/igra2-country-list.txt")[-2]

countries <- read.fwf(textConnection(countries), widths = c(3, 59))

names(countries) <- c("fips", "country_name")
countries <- countries[-1, ] # drop first row that contained colnames

countries <-
  data.frame(lapply(countries, as.character), stringsAsFactors = FALSE)
countries <-
  data.frame(lapply(countries, trimws), stringsAsFactors = FALSE)
countries$country_name <- toupper(countries$country_name)

country_list <- merge(x = countries,
                      y =  countrycode::codelist,
                      by = "fips")
```

There are unnecessary data in several columns. _GSODR_ only requires the FIPS
code, country name, and ISO codes to function.


```{r remove-uncessesary, echo=TRUE, messages=FALSE}
country_list <- country_list[, c("fips",
                                 "country_name",
                                 "iso2c",
                                 "iso3c")]
names(country_list) <- toupper(names(country_list))
data.table::setDT(country_list, key = "FIPS")

country_list
```

Write .rda file to disk.

```{r write, echo=TRUE, messages=FALSE}
save(country_list, file = "../inst/extdata/country_list.rda",
     compress = "bzip2",
     version = 2)
```
# Notes

## NOAA Policy

Users of these data should take into account the following (from the 
[NCEI website](http://www7.ncdc.noaa.gov/CDO/cdoselect.cmd?datasetabbv=GSOD&countryabbv=&georegionabbv=)):

> "The following data and products may have conditions placed on their international commercial use. They can be used within the U.S. or for non-commercial international activities without restriction. The non-U.S. data cannot be redistributed for commercial purposes. Re-distribution of these data by others must provide this same notification."

[WMO Resolution 40. NOAA Policy](http://www.wmo.int/pages/about/Resolution40.html)

## R System Information

```{r system information, echo=FALSE}
sessioninfo::session_info()
```
