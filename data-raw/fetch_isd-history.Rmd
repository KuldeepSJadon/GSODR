---
title: "Fetch, Clean and Correct Altitude in GSOD 'isd_history.csv' Data"
author: "Adam H. Sparks"
date: "`r Sys.Date()`"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

The isd_history file details station metadata including the start and stop years used by GSODR to pre-check requests before querying the server for download and the country code used by GSODR when subsetting for requests by country.

# Data Processing

## Set up workspace

```{r set_up_workspace, echo=TRUE, message=FALSE, output=FALSE, warning=FALSE}
if (!require("readr")) {
  install.packages("readr", repos = "https://cran.rstudio.com/")
}

if (!require("sessioninfo")) {
  install.packages("sessioninfo", repos = "https://cran.rstudio.com/")
}

if (!require("skimr")) {
  install.packages("skimr", repos = "https://cran.rstudio.com/")
}

if (!require("data.table")) {
  install.packages("data.table", repos = "https://cran.rstudio.com/")
}
```

## Download data from Natural Earth and NCEI

```{r download_NE_data, echo=TRUE, message=FALSE, warning=FALSE}
# download data
isd_history <- read_csv(
  "ftp://ftp.ncdc.noaa.gov/pub/data/noaa/isd-history.csv",
  col_types = "ccccccdddii",
  col_names = c(
    "USAF",
    "WBAN",
    "STN_NAME",
    "CTRY",
    "STATE",
    "CALL",
    "LAT",
    "LON",
    "ELEV_M",
    "BEGIN",
    "END"
  ),
  skip = 1
)
```

## Add/drop columns and save to disk

```{r clean_and_reformat, echo=TRUE, cache=FALSE}
# add STNID column
setDT(isd_history)
isd_history[, STNID := paste(USAF, WBAN, sep = "-")]

# clean data
isd_history[, c("USAF", "WBAN", "STN_NAME", "LAT", "LON", "ELEV_M") := NULL]

setkey(isd_history, "STNID")

# write rda file to disk for use with GSODR package
save(isd_history,
     file = "../inst/extdata/isd_history.rda",
     compress = "bzip2",
     version = 2)
```

# Notes

## NOAA Policy

Users of these data should take into account the following (from the
[NCEI website](http://www7.ncdc.noaa.gov/CDO/cdoselect.cmd?datasetabbv=GSOD&countryabbv=&georegionabbv=)): 

> "The following data and products may have conditions placed on their
international commercial use. They can be used within the U.S. or for
non-commercial international activities without restriction. The non-U.S. data
cannot be redistributed for commercial purposes. Re-distribution of these data
by others must provide this same notification."
[WMO Resolution 40. NOAA Policy](http://www.wmo.int/pages/about/Resolution40.html)

## R System Information

```{r system_information, echo=FALSE}
session_info()
```
